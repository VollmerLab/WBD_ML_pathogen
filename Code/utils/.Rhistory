group_by(year, season) %>%
mutate(fdr = p.adjust(p.value, 'fdr')) %>%
ungroup %>%
mutate(estimate = str_c(round(estimate, 1), round(SE, 2), sep = '+-'),
estimate = if_else(fdr < 0.05, str_c(estimate, ' *'), estimate),
.keep = 'unused') %>%
select(-df, -t.ratio, -contains('p.value')) %>%
pivot_wider(names_from = c(year, season),
values_from = estimate) %>%
relocate(`2017_S`, .after = `2016_W`) %>%
select(-contrast)
tank_out <- read_rds('../../intermediate_files/tank_asv_models.rds.gz') %>%
filter(asv_id %in% ml_model_out$asv_id) %>%
inner_join(mutate(field_asv_models, across(contains('p.within'), ~p.adjust(., method = 'fdr'))) %>%
filter_at(vars(contains('p.within')), all_vars(. < alpha)) %>%
select(asv_id),
by = 'asv_id') %>%
select(asv_id, tank_posthoc) %>%
unnest(tank_posthoc) %>%
group_by(contrast) %>%
mutate(fdr = p.adjust(p.value, 'fdr')) %>%
ungroup %>%
mutate(estimate = str_c(round(estimate, 1), round(std.error, 2), sep = '+-'),
estimate = if_else(fdr < 0.05, str_c(estimate, ' *'), estimate),
.keep = 'unused') %>%
select(asv_id, contrast, estimate) %>%
pivot_wider(names_from = c(contrast),
values_from = estimate) %>%
mutate(likely_type = case_when(str_detect(DDvDH, '\\*') &
str_detect(DvH, '\\*') &
str_detect(PostvPreD, '\\*') ~ 'Pathogen',
str_detect(DvN, '\\*') &
str_detect(PostvPreD, '\\*') ~ 'Opportunist',
TRUE ~ 'Commensalist'))
read_csv('../../intermediate_files/update_taxonomy.csv')
taxonomy <- read_csv('../../intermediate_files/taxonomy.csv.gz',
show_col_types = FALSE) %>%
mutate(across(everything(), ~str_replace_na(., '')),
show_col_types = FALSE)
taxonomy <- read_csv('../../intermediate_files/taxonomy.csv.gz',
show_col_types = FALSE) %>%
mutate(across(everything(), ~str_replace_na(., '')))
read_csv('../../intermediate_files/update_taxonomy.csv',
show_col_types = FALSE)
asv_table
asv_table <- select(ml_model_out, phylum:genus,
asv_id, median_rank, FDR) %>%
full_join(field_out,
by = 'asv_id') %>%
relocate(`2016_W`, .before = `2016_S`) %>%
relocate(`2017_W`, .before = `2017_S`) %>%
left_join(tank_out,
by = 'asv_id') %>%
relocate(`2016_W`, .before = `2016_S`) %>%
relocate(`2017_W`, .before = `2017_S`) %>%
rename(Family = family,
Genus = genus,
ID = asv_id) %>%
mutate(across(where(is.character), ~str_replace_all(., '\\+-', ' ± '))) %>%
rename('Median Rank' = median_rank) %>%
relocate(`PostvPreD`, .after = `2017_S`) %>%
relocate(`PostvPreH`, .after = `2017_S`) %>%
relocate(`DvN`, .after = `PostvPreD`)
asv_table
asv_table <- select(ml_model_out, phylum:species,
asv_id, median_rank, FDR) %>%
full_join(field_out,
by = 'asv_id') %>%
relocate(`2016_W`, .before = `2016_S`) %>%
relocate(`2017_W`, .before = `2017_S`) %>%
left_join(tank_out,
by = 'asv_id') %>%
relocate(`2016_W`, .before = `2016_S`) %>%
relocate(`2017_W`, .before = `2017_S`) %>%
rename(Family = family,
Genus = genus,
ID = asv_id) %>%
mutate(across(where(is.character), ~str_replace_all(., '\\+-', ' ± '))) %>%
rename('Median Rank' = median_rank) %>%
relocate(`PostvPreD`, .after = `2017_S`) %>%
relocate(`PostvPreH`, .after = `2017_S`) %>%
relocate(`DvN`, .after = `PostvPreD`)
asv_table
select(ml_model_out, phylum:species,
asv_id, median_rank, FDR)
asv_table <- select(ml_model_out, phylum:species,
asv_id, median_rank, FDR) %>%
relocate(`asv_id`, .after = `species`) %>%
full_join(field_out,
by = 'asv_id') %>%
relocate(`2016_W`, .before = `2016_S`) %>%
relocate(`2017_W`, .before = `2017_S`) %>%
left_join(tank_out,
by = 'asv_id') %>%
relocate(`2016_W`, .before = `2016_S`) %>%
relocate(`2017_W`, .before = `2017_S`) %>%
rename(Family = family,
Genus = genus,
Species = Species,
ID = asv_id) %>%
mutate(across(where(is.character), ~str_replace_all(., '\\+-', ' ± '))) %>%
rename('Median Rank' = median_rank) %>%
relocate(`PostvPreD`, .after = `2017_S`) %>%
relocate(`PostvPreH`, .after = `2017_S`) %>%
relocate(`DvN`, .after = `PostvPreD`)
asv_table <- select(ml_model_out, phylum:species,
asv_id, median_rank, FDR) %>%
relocate(`asv_id`, .after = `species`) %>%
full_join(field_out,
by = 'asv_id') %>%
relocate(`2016_W`, .before = `2016_S`) %>%
relocate(`2017_W`, .before = `2017_S`) %>%
left_join(tank_out,
by = 'asv_id') %>%
relocate(`2016_W`, .before = `2016_S`) %>%
relocate(`2017_W`, .before = `2017_S`) %>%
rename(Family = family,
Genus = genus,
Species = species,
ID = asv_id) %>%
mutate(across(where(is.character), ~str_replace_all(., '\\+-', ' ± '))) %>%
rename('Median Rank' = median_rank) %>%
relocate(`PostvPreD`, .after = `2017_S`) %>%
relocate(`PostvPreH`, .after = `2017_S`) %>%
relocate(`DvN`, .after = `PostvPreD`)
asv_table
asv_table
taxonom_confidence
taxonom_confidence <- read_csv('../../intermediate_files/update_taxonomy.csv',
show_col_types = FALSE)
taxonom_confidence
select(ml_model_out, phylum:species,
asv_id, median_rank, FDR) %>%
relocate(`asv_id`, .after = `species`) %>%
left_join(taxonom_confidence,
by = 'asv_out')
select(ml_model_out, phylum:species,
asv_id, median_rank, FDR) %>%
relocate(`asv_id`, .after = `species`) %>%
left_join(select(taxonom_confidence, asv_id, ends_with('confidence')),
by = 'asv_id')
asv_table <- select(ml_model_out, phylum:species,
asv_id, median_rank, FDR) %>%
relocate(`asv_id`, .after = `species`) %>%
left_join(select(taxonom_confidence, asv_id, ends_with('confidence')),
by = 'asv_id') %>%
relocate(`asv_id`, median_rank, FDR, .after = `species_confidence`) %>%
full_join(field_out,
by = 'asv_id') %>%
relocate(`2016_W`, .before = `2016_S`) %>%
relocate(`2017_W`, .before = `2017_S`) %>%
left_join(tank_out,
by = 'asv_id') %>%
relocate(`2016_W`, .before = `2016_S`) %>%
relocate(`2017_W`, .before = `2017_S`) %>%
rename(Family = family,
Genus = genus,
Species = species,
ID = asv_id) %>%
mutate(across(where(is.character), ~str_replace_all(., '\\+-', ' ± '))) %>%
rename('Median Rank' = median_rank) %>%
relocate(`PostvPreD`, .after = `2017_S`) %>%
relocate(`PostvPreH`, .after = `2017_S`) %>%
relocate(`DvN`, .after = `PostvPreD`)
asv_table
View(asv_table)
write_csv(asv_table, '../../Results/Table45_asv_table.csv')
library(tidyverse)
library(emmeans)
alpha <- 0.05
taxonomy <- read_csv('../../intermediate_files/taxonomy.csv.gz',
show_col_types = FALSE) %>%
mutate(across(everything(), ~str_replace_na(., '')))
taxonom_confidence <- read_csv('../../intermediate_files/update_taxonomy.csv',
show_col_types = FALSE)
ml_model_out <- read_csv('../../Results/asv_importance.csv.gz', show_col_types = FALSE) %>%
left_join(taxonomy, ., by = 'asv_id') %>%
rename(FDR = p_adjust) %>%
# group_by(family, genus) %>%
# filter(any(FDR < 0.05)) %>%
# ungroup %>%
filter(FDR < 0.05) %>%
arrange(domain, phylum, class, order, family, genus, median_rank) %>%
select(-contains('method'), -contains('alternative'), -contains('domain')) %>%
relocate(asv_id, .after = 'genus') %>%
rename_with(~str_remove(., 'base_') %>%
str_replace_all(c('forest' = 'Random Forest',
'knn' = 'KNN',
'lasso' = 'LASSO',
'mlp' = 'MLP',
'null' = 'Null',
'pls' = 'PLS',
'svmLinear' = 'SVM'))) %>%
mutate(#p.value = scales::pvalue(p.value, 0.0001),
FDR = scales::pvalue(FDR, 0.001)) %>%
arrange(median_rank)
field_asv_models <- read_rds('../../intermediate_files/field_asv_models.rds.gz') %>%
filter(asv_id %in% ml_model_out$asv_id) %>%
rowwise %>%
mutate(pct_site = summary(model)$varcor %>%
as_tibble() %>%
mutate(pct_var = vcov / sum(vcov)) %>%
filter(grp == 'site') %>%
pull(pct_var)) %>%
ungroup
field_out <- select(field_asv_models, asv_id, tp_contrasts) %>%
unnest(tp_contrasts) %>%
group_by(year, season) %>%
mutate(fdr = p.adjust(p.value, 'fdr')) %>%
ungroup %>%
mutate(estimate = str_c(round(estimate, 1), round(SE, 2), sep = '+-'),
estimate = if_else(fdr < 0.05, str_c(estimate, ' *'), estimate),
.keep = 'unused') %>%
select(-df, -t.ratio, -contains('p.value')) %>%
pivot_wider(names_from = c(year, season),
values_from = estimate) %>%
relocate(`2017_S`, .after = `2016_W`) %>%
select(-contrast)
tank_out <- read_rds('../../intermediate_files/tank_asv_models.rds.gz') %>%
filter(asv_id %in% ml_model_out$asv_id) %>%
inner_join(mutate(field_asv_models, across(contains('p.within'), ~p.adjust(., method = 'fdr'))) %>%
filter_at(vars(contains('p.within')), all_vars(. < alpha)) %>%
select(asv_id),
by = 'asv_id') %>%
select(asv_id, tank_posthoc) %>%
unnest(tank_posthoc) %>%
group_by(contrast) %>%
mutate(fdr = p.adjust(p.value, 'fdr')) %>%
ungroup %>%
mutate(estimate = str_c(round(estimate, 1), round(std.error, 2), sep = '+-'),
estimate = if_else(fdr < 0.05, str_c(estimate, ' *'), estimate),
.keep = 'unused') %>%
select(asv_id, contrast, estimate) %>%
pivot_wider(names_from = c(contrast),
values_from = estimate) %>%
mutate(likely_type = case_when(str_detect(DDvDH, '\\*') &
str_detect(DvH, '\\*') &
str_detect(PostvPreD, '\\*') ~ 'Pathogen',
str_detect(DvN, '\\*') &
str_detect(PostvPreD, '\\*') ~ 'Opportunist',
TRUE ~ 'Commensalist'))
asv_table <- select(ml_model_out, phylum:species,
asv_id, median_rank, FDR) %>%
relocate(`asv_id`, .after = `species`) %>%
left_join(select(taxonom_confidence, asv_id, ends_with('confidence')),
by = 'asv_id') %>%
relocate(`asv_id`, median_rank, FDR, .after = `species_confidence`) %>%
full_join(field_out,
by = 'asv_id') %>%
relocate(`2016_W`, .before = `2016_S`) %>%
relocate(`2017_W`, .before = `2017_S`) %>%
left_join(tank_out,
by = 'asv_id') %>%
relocate(`2016_W`, .before = `2016_S`) %>%
relocate(`2017_W`, .before = `2017_S`) %>%
rename(Family = family,
Genus = genus,
Species = species,
ID = asv_id) %>%
mutate(across(where(is.character), ~str_replace_all(., '\\+-', ' ± '))) %>%
rename('Median Rank' = median_rank) %>%
relocate(`PostvPreD`, .after = `2017_S`) %>%
relocate(`PostvPreH`, .after = `2017_S`) %>%
relocate(`DvN`, .after = `PostvPreD`)
asv_table <- select(ml_model_out, phylum:species,
asv_id, median_rank, FDR) %>%
relocate(`asv_id`, .after = `species`) %>%
left_join(select(taxonom_confidence, asv_id, ends_with('confidence')),
by = 'asv_id') %>%
relocate(`asv_id`, median_rank, FDR, .after = `species_confidence`)
asv_table
asv_table %>%
rename_with(~str_c(., '_name'), .cols = phylum:species)
asv_table %>%
rename_with(~str_c(., '_name'), .cols = phylum:species) %>%
pivot_longer(cols = c(ends_with('name'), ends_with('confidence')))
select(ml_model_out, domain:species,
asv_id, median_rank, FDR)
select(ml_model_out, phylum:species,
asv_id, median_rank, FDR) %>%
relocate(`asv_id`, .after = `species`) %>%
left_join(select(taxonom_confidence, asv_id, ends_with('confidence')) %>%
select(-domain),
by = 'asv_id')
asv_table <- select(ml_model_out, phylum:species,
asv_id, median_rank, FDR) %>%
relocate(`asv_id`, .after = `species`) %>%
left_join(select(taxonom_confidence, asv_id, ends_with('confidence')) %>%
select(-domain_confidence),
by = 'asv_id') %>%
relocate(`asv_id`, median_rank, FDR, .after = `species_confidence`)
asv_table
asv_table %>%
rename_with(~str_c(., '_name'), .cols = phylum:species) %>%
pivot_longer(cols = c(ends_with('name'), ends_with('confidence')),
names_to = c('taxon_level', '.value'),
names_pattern = '(.*)_(.*)')
?scales::percent
asv_table %>%
rename_with(~str_c(., '_name'), .cols = phylum:species) %>%
pivot_longer(cols = c(ends_with('name'), ends_with('confidence')),
names_to = c('taxon_level', '.value'),
names_pattern = '(.*)_(.*)') %>%
mutate(name = str_c(name, scales::percent(confidence, scale = 1))))
asv_table %>%
rename_with(~str_c(., '_name'), .cols = phylum:species) %>%
pivot_longer(cols = c(ends_with('name'), ends_with('confidence')),
names_to = c('taxon_level', '.value'),
names_pattern = '(.*)_(.*)') %>%
mutate(name = str_c(name, scales::percent(confidence, scale = 1)))
asv_table %>%
rename_with(~str_c(., '_name'), .cols = phylum:species) %>%
pivot_longer(cols = c(ends_with('name'), ends_with('confidence')),
names_to = c('taxon_level', '.value'),
names_pattern = '(.*)_(.*)') %>%
mutate(name = str_c(name, ' (', scales::percent(confidence, scale = 1), ')'))
asv_table %>%
rename_with(~str_c(., '_name'), .cols = phylum:species) %>%
pivot_longer(cols = c(ends_with('name'), ends_with('confidence')),
names_to = c('taxon_level', '.value'),
names_pattern = '(.*)_(.*)') %>%
mutate(name = str_c(name, ' (', scales::percent(confidence, scale = 1), ')')) %>%
arrange(confidence)
asv_table %>%
rename_with(~str_c(., '_name'), .cols = phylum:species) %>%
pivot_longer(cols = c(ends_with('name'), ends_with('confidence')),
names_to = c('taxon_level', '.value'),
names_pattern = '(.*)_(.*)') %>%
mutate(name = str_c(name, ' (', scales::percent(confidence, scale = 1), ')'))
asv_table %>%
rename_with(~str_c(., '_name'), .cols = phylum:species) %>%
pivot_longer(cols = c(ends_with('name'), ends_with('confidence')),
names_to = c('taxon_level', '.value'),
names_pattern = '(.*)_(.*)') %>%
mutate(name = str_c(name, ' (', scales::percent(confidence, scale = 1), ')'),
.keep = 'unusued')
asv_table %>%
rename_with(~str_c(., '_name'), .cols = phylum:species) %>%
pivot_longer(cols = c(ends_with('name'), ends_with('confidence')),
names_to = c('taxon_level', '.value'),
names_pattern = '(.*)_(.*)') %>%
mutate(name = str_c(name, ' (', scales::percent(confidence, scale = 1), ')'),
.keep = 'unusused')
asv_table %>%
rename_with(~str_c(., '_name'), .cols = phylum:species) %>%
pivot_longer(cols = c(ends_with('name'), ends_with('confidence')),
names_to = c('taxon_level', '.value'),
names_pattern = '(.*)_(.*)') %>%
mutate(name = str_c(name, ' (', scales::percent(confidence, scale = 1), ')'),
.keep = 'unused')
asv_table %>%
rename_with(~str_c(., '_name'), .cols = phylum:species) %>%
pivot_longer(cols = c(ends_with('name'), ends_with('confidence')),
names_to = c('taxon_level', '.value'),
names_pattern = '(.*)_(.*)') %>%
mutate(name = str_c(name, ' (', scales::percent(confidence, scale = 1), ')'),
.keep = 'unused') %>%
pivot_wider(names_from = taxon_level, values_from = name)
asv_table %>%
rename_with(~str_c(., '_name'), .cols = phylum:species) %>%
pivot_longer(cols = c(ends_with('name'), ends_with('confidence')),
names_to = c('taxon_level', '.value'),
names_pattern = '(.*)_(.*)') %>%
mutate(name = str_c(name, ' (', scales::percent(confidence, scale = 1), ')'),
.keep = 'unused') %>%
pivot_wider(names_from = taxon_level, values_from = name) %>%
relocate(asv_id:FDR, .after = species)
asv_table <- select(ml_model_out, phylum:species,
asv_id, median_rank, FDR) %>%
relocate(`asv_id`, .after = `species`) %>%
left_join(select(taxonom_confidence, asv_id, ends_with('confidence')) %>%
select(-domain_confidence),
by = 'asv_id') %>%
rename_with(~str_c(., '_name'), .cols = phylum:species) %>%
pivot_longer(cols = c(ends_with('name'), ends_with('confidence')),
names_to = c('taxon_level', '.value'),
names_pattern = '(.*)_(.*)') %>%
mutate(name = str_c(name, ' (', scales::percent(confidence, scale = 1), ')'),
.keep = 'unused') %>%
pivot_wider(names_from = taxon_level, values_from = name) %>%
relocate(asv_id:FDR, .after = species) %>%
full_join(field_out,
by = 'asv_id') %>%
relocate(`2016_W`, .before = `2016_S`) %>%
relocate(`2017_W`, .before = `2017_S`) %>%
left_join(tank_out,
by = 'asv_id') %>%
relocate(`2016_W`, .before = `2016_S`) %>%
relocate(`2017_W`, .before = `2017_S`) %>%
rename(Family = family,
Genus = genus,
Species = species,
ID = asv_id) %>%
mutate(across(where(is.character), ~str_replace_all(., '\\+-', ' ± '))) %>%
rename('Median Rank' = median_rank) %>%
relocate(`PostvPreD`, .after = `2017_S`) %>%
relocate(`PostvPreH`, .after = `2017_S`) %>%
relocate(`DvN`, .after = `PostvPreD`)
asv_table
write_csv(asv_table, '../../Results/Table45_asv_table.csv')
asv_table <- select(ml_model_out, phylum:species,
asv_id, median_rank, FDR) %>%
relocate(`asv_id`, .after = `species`) %>%
left_join(select(taxonom_confidence, asv_id, ends_with('confidence')) %>%
select(-domain_confidence),
by = 'asv_id') %>%
rename_with(~str_c(., '_name'), .cols = phylum:species) %>%
pivot_longer(cols = c(ends_with('name'), ends_with('confidence')),
names_to = c('taxon_level', '.value'),
names_pattern = '(.*)_(.*)') %>%
mutate(taxon_level = str_to_sentence(taxon_level),
name = str_c(name, ' (', scales::percent(confidence, scale = 1), ')'),
.keep = 'unused') %>%
pivot_wider(names_from = taxon_level, values_from = name) %>%
relocate(asv_id:FDR, .after = species) %>%
full_join(field_out,
by = 'asv_id') %>%
relocate(`2016_W`, .before = `2016_S`) %>%
relocate(`2017_W`, .before = `2017_S`) %>%
left_join(tank_out,
by = 'asv_id') %>%
relocate(`2016_W`, .before = `2016_S`) %>%
relocate(`2017_W`, .before = `2017_S`) %>%
rename(Family = family,
Genus = genus,
Species = species,
ID = asv_id) %>%
mutate(across(where(is.character), ~str_replace_all(., '\\+-', ' ± '))) %>%
rename('Median Rank' = median_rank) %>%
relocate(`PostvPreD`, .after = `2017_S`) %>%
relocate(`PostvPreH`, .after = `2017_S`) %>%
relocate(`DvN`, .after = `PostvPreD`)
asv_table <- select(ml_model_out, phylum:species,
asv_id, median_rank, FDR) %>%
relocate(`asv_id`, .after = `species`) %>%
left_join(select(taxonom_confidence, asv_id, ends_with('confidence')) %>%
select(-domain_confidence),
by = 'asv_id') %>%
rename_with(~str_c(., '_name'), .cols = phylum:species) %>%
pivot_longer(cols = c(ends_with('name'), ends_with('confidence')),
names_to = c('taxon_level', '.value'),
names_pattern = '(.*)_(.*)') %>%
mutate(taxon_level = str_to_sentence(taxon_level),
name = str_c(name, ' (', scales::percent(confidence, scale = 1), ')'),
.keep = 'unused') %>%
pivot_wider(names_from = taxon_level, values_from = name) %>%
relocate(asv_id:FDR, .after = Species) %>%
full_join(field_out,
by = 'asv_id') %>%
relocate(`2016_W`, .before = `2016_S`) %>%
relocate(`2017_W`, .before = `2017_S`) %>%
left_join(tank_out,
by = 'asv_id') %>%
relocate(`2016_W`, .before = `2016_S`) %>%
relocate(`2017_W`, .before = `2017_S`) %>%
rename(Family = family,
Genus = genus,
Species = species,
ID = asv_id) %>%
mutate(across(where(is.character), ~str_replace_all(., '\\+-', ' ± '))) %>%
rename('Median Rank' = median_rank) %>%
relocate(`PostvPreD`, .after = `2017_S`) %>%
relocate(`PostvPreH`, .after = `2017_S`) %>%
relocate(`DvN`, .after = `PostvPreD`)
asv_table <- select(ml_model_out, phylum:species,
asv_id, median_rank, FDR) %>%
relocate(`asv_id`, .after = `species`) %>%
left_join(select(taxonom_confidence, asv_id, ends_with('confidence')) %>%
select(-domain_confidence),
by = 'asv_id') %>%
rename_with(~str_c(., '_name'), .cols = phylum:species) %>%
pivot_longer(cols = c(ends_with('name'), ends_with('confidence')),
names_to = c('taxon_level', '.value'),
names_pattern = '(.*)_(.*)') %>%
mutate(taxon_level = str_to_sentence(taxon_level),
name = str_c(name, ' (', scales::percent(confidence, scale = 1), ')'),
.keep = 'unused') %>%
pivot_wider(names_from = taxon_level, values_from = name) %>%
relocate(asv_id:FDR, .after = Species) %>%
full_join(field_out,
by = 'asv_id') %>%
relocate(`2016_W`, .before = `2016_S`) %>%
relocate(`2017_W`, .before = `2017_S`) %>%
left_join(tank_out,
by = 'asv_id') %>%
relocate(`2016_W`, .before = `2016_S`) %>%
relocate(`2017_W`, .before = `2017_S`) %>%
rename(ID = asv_id) %>%
mutate(across(where(is.character), ~str_replace_all(., '\\+-', ' ± '))) %>%
rename('Median Rank' = median_rank) %>%
relocate(`PostvPreD`, .after = `2017_S`) %>%
relocate(`PostvPreH`, .after = `2017_S`) %>%
relocate(`DvN`, .after = `PostvPreD`)
asv_table
write_csv(asv_table, '../../Results/Table45_asv_table.csv')
library(tidyverse)
new_taxonomy <- read_delim('../../intermediate_files/all_asvs.fasta.blca.out', delim = '\t',
col_names = c('asv_id', 'taxonomy'), show_col_types = FALSE) %>%
mutate(superkingdom = str_extract(taxonomy, 'superkingdom:.*;[0-9\\.]+;phylum') %>% str_remove_all('superkingdom:|;phylum'),
phylum = str_extract(taxonomy, 'phylum:.*;[0-9\\.]+;class') %>% str_remove_all('phylum:|;class'),
class = str_extract(taxonomy, 'class:.*;[0-9\\.]+;order') %>% str_remove_all('class:|;order'),
order = str_extract(taxonomy, 'order:.*;[0-9\\.]+;family') %>% str_remove_all('order:|;family'),
family = str_extract(taxonomy, 'family:.*;[0-9\\.]+;genus') %>% str_remove_all('family:|;genus'),
genus = str_extract(taxonomy, 'genus:.*;[0-9\\.]+;species') %>% str_remove_all('genus:|;species'),
species = str_extract(taxonomy, 'species:.*;[0-9\\.]+') %>% str_remove_all('species:'),
.keep = 'unused') %>%
rename(domain = superkingdom) %>%
# select(asv_id, superkingdom, phylum) %>%
mutate(across(-asv_id, ~str_extract(., ';.*$') %>% str_remove(';') %>%
parse_number(), .names = '{.col}_confidence'),
across(where(is.character), ~str_remove(., ';.*$')))
new_taxonomy
