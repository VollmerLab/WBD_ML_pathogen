mutate(taxon_level = as.character(taxon_level)) %>%
select(-confidence) %>%
mutate(sequence = as_dna(as.character(panama_sequences[asv_id]))) %>%
expand_grid(datasouce = c('rosales', 'klinges', 'trytten', 'sweet')) %>%
mutate(compare_taxa = case_when(datasouce == 'rosales' ~ list(rosales_taxonomy),
datasouce == 'klinges' ~ list(klinges_taxonomy),
datasouce == 'trytten' ~ list(trytten_taxonomy),
datasource == 'sweet' ~ list(sweet_taxonomy),
TRUE ~ list(NULL)),
compare_seqs = case_when(datasouce == 'rosales' ~ list(rosales_sequences),
datasouce == 'klinges' ~ list(klinges_sequences),
datasouce == 'trytten' ~ list(trytten_sequences),
datasouce == 'sweet' ~ list(sweet_sequences),
TRUE ~ list(NULL)))
sweet_sequences
trytten_sequences
klinges_sequences
rosales_sequences
sweet_taxonomy
trytten_taxonomy
sweet_taxonomy
matched_sequences <- inner_join(panama_taxonomy,
top_asvs,
by = 'asv_id') %>%
top_classification %>%
mutate(taxon_level = as.character(taxon_level)) %>%
select(-confidence) %>%
mutate(sequence = as_dna(as.character(panama_sequences[asv_id]))) %>%
expand_grid(datasouce = c('rosales', 'klinges', 'trytten', 'sweet')) %>%
mutate(compare_taxa = case_when(datasouce == 'rosales' ~ list(rosales_taxonomy),
datasouce == 'klinges' ~ list(klinges_taxonomy),
datasouce == 'trytten' ~ list(trytten_taxonomy),
datasource == 'sweet' ~ list(sweet_taxonomy),
TRUE ~ list(NULL)))
matched_sequences <- inner_join(panama_taxonomy,
top_asvs,
by = 'asv_id') %>%
top_classification %>%
mutate(taxon_level = as.character(taxon_level)) %>%
select(-confidence) %>%
mutate(sequence = as_dna(as.character(panama_sequences[asv_id]))) %>%
expand_grid(datasouce = c('rosales', 'klinges', 'trytten', 'sweet')) %>%
rowwise %>%
mutate(compare_taxa = case_when(datasouce == 'rosales' ~ list(rosales_taxonomy),
datasouce == 'klinges' ~ list(klinges_taxonomy),
datasouce == 'trytten' ~ list(trytten_taxonomy),
datasource == 'sweet' ~ list(sweet_taxonomy),
TRUE ~ list(NULL)),
compare_seqs = case_when(datasouce == 'rosales' ~ list(rosales_sequences),
datasouce == 'klinges' ~ list(klinges_sequences),
datasouce == 'trytten' ~ list(trytten_sequences),
datasouce == 'sweet' ~ list(sweet_sequences),
TRUE ~ list(NULL))) %>%
ungroup
matched_sequences <- inner_join(panama_taxonomy,
top_asvs,
by = 'asv_id') %>%
top_classification %>%
mutate(taxon_level = as.character(taxon_level)) %>%
select(-confidence) %>%
mutate(sequence = as_dna(as.character(panama_sequences[asv_id]))) %>%
expand_grid(datasouce = c('rosales', 'klinges', 'trytten', 'sweet')) %>%
mutate(compare_taxa = case_when(datasouce == 'rosales' ~ list(rosales_taxonomy),
datasouce == 'klinges' ~ list(klinges_taxonomy),
datasouce == 'trytten' ~ list(trytten_taxonomy),
# datasource == 'sweet' ~ list(sweet_taxonomy),
TRUE ~ list(NULL)),
compare_seqs = case_when(datasouce == 'rosales' ~ list(rosales_sequences),
datasouce == 'klinges' ~ list(klinges_sequences),
datasouce == 'trytten' ~ list(trytten_sequences),
# datasouce == 'sweet' ~ list(sweet_sequences),
TRUE ~ list(NULL))) %>%
filter(lengths(compare_taxa) > 0) %>%
rowwise() %>%
mutate(compare_taxa = list(filter_taxa(compare_taxa, level = taxon_level, id = name) %>%
top_classification()),
compare_seqs = list(compare_seqs[compare_taxa$asv_id])) %>%
mutate(compare = list(as_dna(as.character(compare_seqs)) %>%
tibble(asv_id = names(.),
sequence = .) %>%
left_join(compare_taxa,
by = 'asv_id') %>%
rename_with(~str_c(., '_compare'))),
.keep = 'unused') %>%
unnest(compare)
matched_sequences <- inner_join(panama_taxonomy,
top_asvs,
by = 'asv_id') %>%
top_classification %>%
mutate(taxon_level = as.character(taxon_level)) %>%
select(-confidence) %>%
mutate(sequence = as_dna(as.character(panama_sequences[asv_id]))) %>%
expand_grid(datasouce = c('rosales', 'klinges', 'trytten', 'sweet')) %>%
mutate(compare_taxa = case_when(datasouce == 'rosales' ~ list(rosales_taxonomy),
datasouce == 'klinges' ~ list(klinges_taxonomy),
datasouce == 'trytten' ~ list(trytten_taxonomy),
# datasource == 'sweet' ~ list(sweet_taxonomy),
TRUE ~ list(NULL)),
compare_seqs = case_when(datasouce == 'rosales' ~ list(rosales_sequences),
datasouce == 'klinges' ~ list(klinges_sequences),
datasouce == 'trytten' ~ list(trytten_sequences),
datasouce == 'sweet' ~ list(sweet_sequences),
TRUE ~ list(NULL))) %>%
filter(lengths(compare_taxa) > 0)
matched_sequences <- inner_join(panama_taxonomy,
top_asvs,
by = 'asv_id') %>%
top_classification %>%
mutate(taxon_level = as.character(taxon_level)) %>%
select(-confidence) %>%
mutate(sequence = as_dna(as.character(panama_sequences[asv_id]))) %>%
expand_grid(datasouce = c('rosales', 'klinges', 'trytten', 'sweet')) %>%
mutate(compare_taxa = case_when(datasouce == 'rosales' ~ list(rosales_taxonomy),
datasouce == 'klinges' ~ list(klinges_taxonomy),
datasouce == 'trytten' ~ list(trytten_taxonomy),
datasource == 'sweet' ~ list(sweet_taxonomy),
TRUE ~ list(NULL)),
compare_seqs = case_when(datasouce == 'rosales' ~ list(rosales_sequences),
datasouce == 'klinges' ~ list(klinges_sequences),
datasouce == 'trytten' ~ list(trytten_sequences),
datasouce == 'sweet' ~ list(sweet_sequences),
TRUE ~ list(NULL))) %>%
filter(lengths(compare_taxa) > 0)
sweet_taxonomy
klinges_taxonomy
matched_sequences <- inner_join(panama_taxonomy,
top_asvs,
by = 'asv_id') %>%
top_classification %>%
mutate(taxon_level = as.character(taxon_level)) %>%
select(-confidence) %>%
mutate(sequence = as_dna(as.character(panama_sequences[asv_id]))) %>%
expand_grid(datasouce = c('rosales', 'klinges', 'trytten', 'sweet')) %>%
mutate(compare_taxa = case_when(datasouce == 'rosales' ~ list(rosales_taxonomy),
datasouce == 'klinges' ~ list(klinges_taxonomy),
datasouce == 'trytten' ~ list(trytten_taxonomy),
datasouce == 'sweet' ~ list(sweet_taxonomy),
TRUE ~ list(NULL)),
compare_seqs = case_when(datasouce == 'rosales' ~ list(rosales_sequences),
datasouce == 'klinges' ~ list(klinges_sequences),
datasouce == 'trytten' ~ list(trytten_sequences),
datasouce == 'sweet' ~ list(sweet_sequences),
TRUE ~ list(NULL))) %>%
filter(lengths(compare_taxa) > 0)
matched_sequences <- inner_join(panama_taxonomy,
top_asvs,
by = 'asv_id') %>%
top_classification %>%
mutate(taxon_level = as.character(taxon_level)) %>%
select(-confidence) %>%
mutate(sequence = as_dna(as.character(panama_sequences[asv_id]))) %>%
expand_grid(datasouce = c('rosales', 'klinges', 'trytten', 'sweet')) %>%
mutate(compare_taxa = case_when(datasouce == 'rosales' ~ list(rosales_taxonomy),
datasouce == 'klinges' ~ list(klinges_taxonomy),
datasouce == 'trytten' ~ list(trytten_taxonomy),
datasouce == 'sweet' ~ list(sweet_taxonomy),
TRUE ~ list(NULL)),
compare_seqs = case_when(datasouce == 'rosales' ~ list(rosales_sequences),
datasouce == 'klinges' ~ list(klinges_sequences),
datasouce == 'trytten' ~ list(trytten_sequences),
datasouce == 'sweet' ~ list(sweet_sequences),
TRUE ~ list(NULL))) %>%
filter(lengths(compare_taxa) > 0) %>%
rowwise() %>%
mutate(compare_taxa = list(filter_taxa(compare_taxa, level = taxon_level, id = name) %>%
top_classification()),
compare_seqs = list(compare_seqs[compare_taxa$asv_id])) %>%
mutate(compare = list(as_dna(as.character(compare_seqs)) %>%
tibble(asv_id = names(.),
sequence = .) %>%
left_join(compare_taxa,
by = 'asv_id') %>%
rename_with(~str_c(., '_compare'))),
.keep = 'unused') %>%
unnest(compare)
matched_sequences <- inner_join(panama_taxonomy,
top_asvs,
by = 'asv_id') %>%
top_classification %>%
mutate(taxon_level = as.character(taxon_level)) %>%
select(-confidence) %>%
mutate(sequence = as_dna(as.character(panama_sequences[asv_id]))) %>%
expand_grid(datasouce = c('rosales', 'klinges', 'trytten', 'sweet')) %>%
mutate(compare_taxa = case_when(datasouce == 'rosales' ~ list(rosales_taxonomy),
datasouce == 'klinges' ~ list(klinges_taxonomy),
datasouce == 'trytten' ~ list(trytten_taxonomy),
datasouce == 'sweet' ~ list(sweet_taxonomy),
TRUE ~ list(NULL)),
compare_seqs = case_when(datasouce == 'rosales' ~ list(rosales_sequences),
datasouce == 'klinges' ~ list(klinges_sequences),
datasouce == 'trytten' ~ list(trytten_sequences),
datasouce == 'sweet' ~ list(sweet_sequences),
TRUE ~ list(NULL))) %>%
filter(lengths(compare_taxa) > 0) %>%
rowwise()
matched_sequences
matched_sequences <- inner_join(panama_taxonomy,
top_asvs,
by = 'asv_id') %>%
top_classification %>%
mutate(taxon_level = as.character(taxon_level)) %>%
select(-confidence) %>%
mutate(sequence = as_dna(as.character(panama_sequences[asv_id]))) %>%
expand_grid(datasouce = c('rosales', 'klinges', 'trytten', 'sweet')) %>%
mutate(compare_taxa = case_when(datasouce == 'rosales' ~ list(rosales_taxonomy),
datasouce == 'klinges' ~ list(klinges_taxonomy),
datasouce == 'trytten' ~ list(trytten_taxonomy),
datasouce == 'sweet' ~ list(sweet_taxonomy),
TRUE ~ list(NULL)),
compare_seqs = case_when(datasouce == 'rosales' ~ list(rosales_sequences),
datasouce == 'klinges' ~ list(klinges_sequences),
datasouce == 'trytten' ~ list(trytten_sequences),
datasouce == 'sweet' ~ list(sweet_sequences),
TRUE ~ list(NULL))) %>%
filter(lengths(compare_taxa) > 0) %>%
rowwise() %>%
mutate(compare_taxa = list(filter_taxa(compare_taxa, level = taxon_level, id = name) %>%
top_classification()))
matched_sequences <- inner_join(panama_taxonomy,
top_asvs,
by = 'asv_id') %>%
top_classification %>%
mutate(taxon_level = as.character(taxon_level)) %>%
select(-confidence) %>%
mutate(sequence = as_dna(as.character(panama_sequences[asv_id]))) %>%
expand_grid(datasouce = c('rosales', 'klinges', 'trytten', 'sweet')) %>%
mutate(compare_taxa = case_when(datasouce == 'rosales' ~ list(rosales_taxonomy),
datasouce == 'klinges' ~ list(klinges_taxonomy),
datasouce == 'trytten' ~ list(trytten_taxonomy),
datasouce == 'sweet' ~ list(sweet_taxonomy),
TRUE ~ list(NULL)),
compare_seqs = case_when(datasouce == 'rosales' ~ list(rosales_sequences),
datasouce == 'klinges' ~ list(klinges_sequences),
datasouce == 'trytten' ~ list(trytten_sequences),
datasouce == 'sweet' ~ list(sweet_sequences),
TRUE ~ list(NULL))) %>%
filter(lengths(compare_taxa) > 0) %>%
rowwise()
matched_sequences
data <- matched_sequences$compare_taxa[[4]]; level = matched_sequences$taxon_level[[4]]; id = matched_sequences$name[[4]]
filter(data, !!sym(level) == id)
filter_taxa(matched_sequences$compare_taxa[[4]], level = matched_sequences$taxon_level[[4]], id = matched_sequences$name[[4]])
filter_taxa(matched_sequences$compare_taxa[[4]], level = matched_sequences$taxon_level[[4]], id = matched_sequences$name[[4]]) %>%
top_classification()
matched_sequences
source("~/Google Drive/Research/Vollmer Lab PostDoc/Panama_Tank_Field/Code/utils/compare_rosales_klinges_trytten_seqs.R", echo=TRUE)
filter_taxa(matched_sequences$compare_taxa[[8]], level = matched_sequences$taxon_level[[8]], id = matched_sequences$name[[8]]) %>%
top_classification()
filter_taxa(matched_sequences$compare_taxa[[8]], level = matched_sequences$taxon_level[[8]], id = matched_sequences$name[[8]])
filter_taxa(matched_sequences$compare_taxa[[12]], level = matched_sequences$taxon_level[[12]], id = matched_sequences$name[[12]]) %>%
top_classification()
matched_sequences <- inner_join(panama_taxonomy,
top_asvs,
by = 'asv_id') %>%
top_classification %>%
mutate(taxon_level = as.character(taxon_level)) %>%
select(-confidence) %>%
mutate(sequence = as_dna(as.character(panama_sequences[asv_id]))) %>%
expand_grid(datasouce = c('rosales', 'klinges', 'trytten', 'sweet')) %>%
mutate(compare_taxa = case_when(datasouce == 'rosales' ~ list(rosales_taxonomy),
datasouce == 'klinges' ~ list(klinges_taxonomy),
datasouce == 'trytten' ~ list(trytten_taxonomy),
datasouce == 'sweet' ~ list(sweet_taxonomy),
TRUE ~ list(NULL)),
compare_seqs = case_when(datasouce == 'rosales' ~ list(rosales_sequences),
datasouce == 'klinges' ~ list(klinges_sequences),
datasouce == 'trytten' ~ list(trytten_sequences),
datasouce == 'sweet' ~ list(sweet_sequences),
TRUE ~ list(NULL))) %>%
filter(lengths(compare_taxa) > 0) %>%
rowwise() %>%
mutate(compare_taxa = list(filter_taxa(compare_taxa, level = taxon_level, id = name) %>%
top_classification()))
matched_sequences
matched_sequences$compare_taxa[[4]]
matched_sequences$compare_taxa[[8]]
matched_sequences$compare_taxa[[12]]
matched_sequences <- inner_join(panama_taxonomy,
top_asvs,
by = 'asv_id') %>%
top_classification %>%
mutate(taxon_level = as.character(taxon_level)) %>%
select(-confidence) %>%
mutate(sequence = as_dna(as.character(panama_sequences[asv_id]))) %>%
expand_grid(datasouce = c('rosales', 'klinges', 'trytten', 'sweet')) %>%
mutate(compare_taxa = case_when(datasouce == 'rosales' ~ list(rosales_taxonomy),
datasouce == 'klinges' ~ list(klinges_taxonomy),
datasouce == 'trytten' ~ list(trytten_taxonomy),
datasouce == 'sweet' ~ list(sweet_taxonomy),
TRUE ~ list(NULL)),
compare_seqs = case_when(datasouce == 'rosales' ~ list(rosales_sequences),
datasouce == 'klinges' ~ list(klinges_sequences),
datasouce == 'trytten' ~ list(trytten_sequences),
datasouce == 'sweet' ~ list(sweet_sequences),
TRUE ~ list(NULL))) %>%
filter(lengths(compare_taxa) > 0) %>%
rowwise() %>%
mutate(compare_taxa = list(filter_taxa(compare_taxa, level = taxon_level, id = name) %>%
top_classification())) %>%
filter(nrow(compare_taxa) > 0)
matched_sequences
matched_sequences <- inner_join(panama_taxonomy,
top_asvs,
by = 'asv_id') %>%
top_classification %>%
mutate(taxon_level = as.character(taxon_level)) %>%
select(-confidence) %>%
mutate(sequence = as_dna(as.character(panama_sequences[asv_id]))) %>%
expand_grid(datasouce = c('rosales', 'klinges', 'trytten', 'sweet')) %>%
mutate(compare_taxa = case_when(datasouce == 'rosales' ~ list(rosales_taxonomy),
datasouce == 'klinges' ~ list(klinges_taxonomy),
datasouce == 'trytten' ~ list(trytten_taxonomy),
datasouce == 'sweet' ~ list(sweet_taxonomy),
TRUE ~ list(NULL)),
compare_seqs = case_when(datasouce == 'rosales' ~ list(rosales_sequences),
datasouce == 'klinges' ~ list(klinges_sequences),
datasouce == 'trytten' ~ list(trytten_sequences),
datasouce == 'sweet' ~ list(sweet_sequences),
TRUE ~ list(NULL))) %>%
filter(lengths(compare_taxa) > 0) %>%
rowwise() %>%
mutate(compare_taxa = list(filter_taxa(compare_taxa, level = taxon_level, id = name) %>%
top_classification())) %>%
filter(nrow(compare_taxa) > 0) %>%
mutate(compare_seqs = list(compare_seqs[compare_taxa$asv_id]))
matched_sequences
matched_sequences <- inner_join(panama_taxonomy,
top_asvs,
by = 'asv_id') %>%
top_classification %>%
mutate(taxon_level = as.character(taxon_level)) %>%
select(-confidence) %>%
mutate(sequence = as_dna(as.character(panama_sequences[asv_id]))) %>%
expand_grid(datasouce = c('rosales', 'klinges', 'trytten', 'sweet')) %>%
mutate(compare_taxa = case_when(datasouce == 'rosales' ~ list(rosales_taxonomy),
datasouce == 'klinges' ~ list(klinges_taxonomy),
datasouce == 'trytten' ~ list(trytten_taxonomy),
datasouce == 'sweet' ~ list(sweet_taxonomy),
TRUE ~ list(NULL)),
compare_seqs = case_when(datasouce == 'rosales' ~ list(rosales_sequences),
datasouce == 'klinges' ~ list(klinges_sequences),
datasouce == 'trytten' ~ list(trytten_sequences),
datasouce == 'sweet' ~ list(sweet_sequences),
TRUE ~ list(NULL))) %>%
filter(lengths(compare_taxa) > 0) %>%
rowwise() %>%
mutate(compare_taxa = list(filter_taxa(compare_taxa, level = taxon_level, id = name) %>%
top_classification())) %>%
filter(nrow(compare_taxa) > 0) %>%
mutate(compare_seqs = list(compare_seqs[compare_taxa$asv_id])) %>%
mutate(compare = list(as_dna(as.character(compare_seqs)) %>%
tibble(asv_id = names(.),
sequence = .) %>%
left_join(compare_taxa,
by = 'asv_id') %>%
rename_with(~str_c(., '_compare'))),
.keep = 'unused') %>%
unnest(compare)
matched_sequences
#### Align Sequences ####
aligned_sequences <- matched_sequences %>%
mutate(seqLength = str_length(sequence),
seqLength_compare = str_length(sequence_compare)) %>%
rowwise %>%
mutate(msa(c(DNAStringSet(sequence), DNAStringSet(sequence_compare)), verbose = FALSE) %>%
as.character() %>%
as_dna() %>%
enframe() %>%
mutate(name = if_else(str_detect(name, 'PA_'), 'sequence', 'sequence_compare')) %>%
pivot_wider(),
.keep = 'unused')
#### Trim to Core ####
# seq1 <- aligned_sequences$sequence[[1]]
# seq2 <- aligned_sequences$sequence_compare[[1]]
trim_to_core <- function(seq1, seq2){
leading_missing <- c(seq1, seq2) %>%
str_extract('^-*') %>%
str_length()
tail_missing <- c(seq1, seq2) %>%
str_extract('-*$') %>%
str_length()
the_core <- c(seq1, seq2) %>%
seq_remove_position(1, max(leading_missing)) %>%
seq_remove_position(str_length(.) - max(tail_missing), str_length(.)) %>%
enframe() %>%
mutate(name = if_else(str_detect(name, '1'), 'sequence', 'sequence_compare')) %>%
pivot_wider()
the_core
}
trimmed_sequences <- mutate(aligned_sequences,
trim_to_core(sequence, sequence_compare),
.keep = 'unused')
#### Count Sequence Differences ####
make_base_position <- function(the_seq){
as.character(the_seq) %>%
str_split('') %>%
unlist %>%
tibble(bp = .) %>%
mutate(position = row_number()) %>%
select(position, bp)
}
mismatched_sequences <- trimmed_sequences %>%
mutate(across(c(sequence, sequence_compare), ~list(make_base_position(.))),
sequence_compare = list(rename_with(sequence_compare, ~str_c(., '_compare')))) %>%
mutate(both_seqs = list(full_join(sequence, sequence_compare, by = c('position' = 'position_compare'))),
.keep = 'unused') %>%
unnest(both_seqs) %>%
group_by(across(asv_id:seqLength_compare)) %>%
summarise(n_base = n(),
n_original = sum(bp != '-'),
n_compare = sum(bp_compare != '-'),
n_match = sum(bp == bp_compare),
n_mismatch = sum(bp != bp_compare),
.groups = 'drop')
mismatched_sequences
filter(mismatched_sequences, datasouce == 'sweet')
mismatched_sequences %>%
filter((asv_id_compare %in% rosales_asvs & datasouce == 'rosales') |
(asv_id_compare %in% klinges_asvs & datasouce == 'klinges') | #(datasouce == 'klinges') | #Klinges significance is associated with nutrients - all in "disease susceptible" corals
(asv_id_compare %in% trytten_asvs & datasouce == 'trytten') |
(asv_id_compare %in% sweet_asvs & datasouce == 'sweet')) %>%
mutate(pct_mismatch = n_mismatch / n_compare) %>%
select(asv_id, name, datasouce, asv_id_compare, name_compare, n_mismatch, n_compare, pct_mismatch) %>%
select(-asv_id_compare, -name_compare)
matched_sequences <- inner_join(panama_taxonomy,
top_asvs,
by = 'asv_id') %>%
top_classification %>%
mutate(taxon_level = as.character(taxon_level)) %>%
select(-confidence) %>%
mutate(sequence = as_dna(as.character(panama_sequences[asv_id]))) %>%
expand_grid(datasouce = c('rosales', 'klinges', 'trytten', 'sweet')) %>%
mutate(compare_taxa = case_when(datasouce == 'rosales' ~ list(rosales_taxonomy),
datasouce == 'klinges' ~ list(klinges_taxonomy),
datasouce == 'trytten' ~ list(trytten_taxonomy),
datasouce == 'sweet' ~ list(sweet_taxonomy),
TRUE ~ list(NULL)),
compare_seqs = case_when(datasouce == 'rosales' ~ list(rosales_sequences),
datasouce == 'klinges' ~ list(klinges_sequences),
datasouce == 'trytten' ~ list(trytten_sequences),
datasouce == 'sweet' ~ list(sweet_sequences),
TRUE ~ list(NULL))) %>%
filter(lengths(compare_taxa) > 0) %>%
rowwise() %>%
mutate(compare_taxa = list(filter_taxa(compare_taxa, level = taxon_level, id = name) %>%
top_classification())) %>%
# filter(nrow(compare_taxa) > 0) %>%
mutate(compare_seqs = list(compare_seqs[compare_taxa$asv_id])) %>%
mutate(compare = list(as_dna(as.character(compare_seqs)) %>%
tibble(asv_id = names(.),
sequence = .) %>%
left_join(compare_taxa,
by = 'asv_id') %>%
rename_with(~str_c(., '_compare'))),
.keep = 'unused') %>%
unnest(compare)
matched_sequences <- inner_join(panama_taxonomy,
top_asvs,
by = 'asv_id') %>%
top_classification %>%
mutate(taxon_level = as.character(taxon_level)) %>%
select(-confidence) %>%
mutate(sequence = as_dna(as.character(panama_sequences[asv_id]))) %>%
expand_grid(datasouce = c('rosales', 'klinges', 'trytten', 'sweet')) %>%
mutate(compare_taxa = case_when(datasouce == 'rosales' ~ list(rosales_taxonomy),
datasouce == 'klinges' ~ list(klinges_taxonomy),
datasouce == 'trytten' ~ list(trytten_taxonomy),
datasouce == 'sweet' ~ list(sweet_taxonomy),
TRUE ~ list(NULL)),
compare_seqs = case_when(datasouce == 'rosales' ~ list(rosales_sequences),
datasouce == 'klinges' ~ list(klinges_sequences),
datasouce == 'trytten' ~ list(trytten_sequences),
datasouce == 'sweet' ~ list(sweet_sequences),
TRUE ~ list(NULL))) %>%
filter(lengths(compare_taxa) > 0) %>%
rowwise() %>%
mutate(compare_taxa = list(filter_taxa(compare_taxa, level = taxon_level, id = name) %>%
top_classification())) %>%
filter(nrow(compare_taxa) > 0) %>%
mutate(compare_seqs = list(compare_seqs[compare_taxa$asv_id])) %>%
mutate(compare = list(as_dna(as.character(compare_seqs)) %>%
tibble(asv_id = names(.),
sequence = .) %>%
left_join(compare_taxa,
by = 'asv_id') %>%
rename_with(~str_c(., '_compare'))),
.keep = 'unused') %>%
unnest(compare)
mismatched_sequences %>%
filter((asv_id_compare %in% rosales_asvs & datasouce == 'rosales') |
(asv_id_compare %in% klinges_asvs & datasouce == 'klinges') | #(datasouce == 'klinges') | #Klinges significance is associated with nutrients - all in "disease susceptible" corals
(asv_id_compare %in% trytten_asvs & datasouce == 'trytten') |
(asv_id_compare %in% sweet_asvs & datasouce == 'sweet')) %>%
mutate(pct_mismatch = n_mismatch / n_compare) %>%
select(asv_id, name, datasouce, asv_id_compare, name_compare, n_mismatch, n_compare, pct_mismatch) %>%
select(-asv_id_compare, -name_compare)
sweet_asvs
mismatched_sequences %>%
filter((asv_id_compare %in% rosales_asvs & datasouce == 'rosales') |
(asv_id_compare %in% klinges_asvs & datasouce == 'klinges') | #(datasouce == 'klinges') | #Klinges significance is associated with nutrients - all in "disease susceptible" corals
(asv_id_compare %in% trytten_asvs & datasouce == 'trytten') |
(asv_id_compare %in% sweet_asvs & datasouce == 'sweet')) %>%
mutate(pct_mismatch = n_mismatch / n_compare) %>%
select(asv_id, name, datasouce, asv_id_compare, name_compare, n_mismatch, n_compare, pct_mismatch)
mismatched_sequences %>%
filter((asv_id_compare %in% rosales_asvs & datasouce == 'rosales') |
(asv_id_compare %in% klinges_asvs & datasouce == 'klinges') | #(datasouce == 'klinges') | #Klinges significance is associated with nutrients - all in "disease susceptible" corals
(asv_id_compare %in% trytten_asvs & datasouce == 'trytten') |
(asv_id_compare %in% sweet_asvs & datasouce == 'sweet')) %>%
mutate(pct_mismatch = n_mismatch / n_compare) %>%
select(asv_id, name, datasouce, asv_id_compare, name_compare, n_mismatch, n_compare, pct_mismatch) %>%
select(-name_compare)
